<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Market Onitsha - Online Marketplace</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Your existing CSS styles here */
        /* [ALL YOUR EXISTING CSS CODE] */
    </style>
</head>
<body>
    <!-- Your existing HTML structure here -->
    <!-- [ALL YOUR EXISTING HTML CODE] -->

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAd_7YPxHYIM-xn4zySaxIzD1W8JZBP1-E",
            authDomain: "mainmarketonitsha-f1947.firebaseapp.com",
            projectId: "mainmarketonitsha-f1947",
            storageBucket: "mainmarketonitsha-f1947.firebasestorage.app",
            messagingSenderId: "80816751981",
            appId: "1:80816751981:web:a9b355b70e153e650d4664",
            measurementId: "G-ENLKHXDWNN"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ===== FIXED IMAGE UPLOAD FUNCTIONS =====

        // Enhanced product upload with timeout protection
        async function handleAddProduct(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showToast('üîê Please login to add products.', 'error');
                loginModal.style.display = 'flex';
                return;
            }

            const name = document.getElementById('productName').value;
            const category = document.getElementById('productCategory').value;
            const price = parseInt(document.getElementById('productPrice').value);
            const description = document.getElementById('productDescription').value;
            const imageFile = document.getElementById('productImageFile').files[0];

            if (!name || !category || !price) {
                showToast('‚ùå Please fill in all required fields.', 'error');
                return;
            }

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="spinner"></span> Adding product...';
            submitBtn.disabled = true;

            try {
                let imageUrl = 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80';
                
                // Show progress bar
                showUploadProgress(0, 'Preparing upload...');
                
                if (imageFile) {
                    // Compress image first to reduce upload time
                    const compressedFile = await compressImage(imageFile);
                    imageUrl = await uploadImageWithProgress(compressedFile);
                }

                showUploadProgress(100, 'Saving product details...');
                
                const product = {
                    name: name,
                    price: price,
                    category: category,
                    seller: currentUser.displayName || 'Seller',
                    image: imageUrl,
                    description: description || 'No description provided.',
                    sellerId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Save to Firestore with timeout
                const productId = await addProductWithTimeout(product, 8000);
                
                // Reset form
                productForm.reset();
                imagePreview.style.display = 'none';
                hideUploadProgress();
                
                showToast('‚úÖ Product added successfully!', 'success');
                
                // Reload products
                setTimeout(() => loadProducts(), 1000);

            } catch (error) {
                console.error("Error adding product: ", error);
                hideUploadProgress();
                
                if (error.message.includes('timeout') || error.code === 'storage/retry-limit-exceeded') {
                    showToast('‚è∞ Upload too slow. Saved with default image.', 'warning');
                    // Save without image
                    await saveProductWithoutImage(name, category, price, description);
                } else {
                    showToast('‚ùå Failed to add product: ' + error.message, 'error');
                }
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Upload image with progress tracking
        async function uploadImageWithProgress(file) {
            return new Promise((resolve, reject) => {
                const filename = `products/${currentUser.uid}/${Date.now()}-${file.name}`;
                const storageRef = storage.ref();
                const fileRef = storageRef.child(filename);
                const uploadTask = fileRef.put(file);

                // Set timeout for upload (15 seconds max)
                const uploadTimeout = setTimeout(() => {
                    uploadTask.cancel();
                    reject(new Error('Upload timeout after 15 seconds'));
                }, 15000);

                uploadTask.on('state_changed',
                    (snapshot) => {
                        clearTimeout(uploadTimeout); // Reset timeout on progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        showUploadProgress(progress, `Uploading image... ${Math.round(progress)}%`);
                    },
                    (error) => {
                        clearTimeout(uploadTimeout);
                        reject(error);
                    },
                    async () => {
                        clearTimeout(uploadTimeout);
                        try {
                            const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                            resolve(downloadURL);
                        } catch (error) {
                            reject(error);
                        }
                    }
                );
            });
        }

        // Compress image to reduce upload time
        function compressImage(file, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve) => {
                // If file is small, don't compress
                if (file.size < 500000) { // 500KB
                    resolve(file);
                    return;
                }

                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Resize if too large
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob((blob) => {
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            console.log(`Compressed from ${file.size} to ${compressedFile.size} bytes`);
                            resolve(compressedFile);
                        }, 'image/jpeg', quality);
                    };
                };
            });
        }

        // Add product with timeout
        function addProductWithTimeout(product, timeout = 8000) {
            return new Promise(async (resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error('Firestore timeout after ' + timeout + 'ms'));
                }, timeout);

                try {
                    const docRef = await db.collection("products").add(product);
                    clearTimeout(timeoutId);
                    resolve(docRef.id);
                } catch (error) {
                    clearTimeout(timeoutId);
                    reject(error);
                }
            });
        }

        // Save product without image (fallback)
        async function saveProductWithoutImage(name, category, price, description) {
            const product = {
                name: name,
                price: price,
                category: category,
                seller: currentUser.displayName || 'Seller',
                image: 'https://images.unsplash.com/photo-1560472354-b33ff0c44a43?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80',
                description: description || 'No description provided.',
                sellerId: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection("products").add(product);
            showToast('‚úÖ Product saved with default image!', 'success');
        }

        // Progress bar functions
        function showUploadProgress(percent, message) {
            let progressBar = document.getElementById('uploadProgressBar');
            let progressContainer = document.getElementById('uploadProgress');
            let statusText = document.getElementById('uploadStatus');
            
            if (!progressBar) {
                // Create progress elements if they don't exist
                progressContainer = document.createElement('div');
                progressContainer.id = 'uploadProgress';
                progressContainer.className = 'upload-progress';
                progressContainer.style.display = 'block';
                
                progressBar = document.createElement('div');
                progressBar.id = 'uploadProgressBar';
                progressBar.className = 'upload-progress-bar';
                
                statusText = document.createElement('div');
                statusText.id = 'uploadStatus';
                statusText.className = 'upload-status';
                statusText.style.display = 'block';
                
                progressContainer.appendChild(progressBar);
                productForm.insertBefore(progressContainer, productForm.querySelector('button[type="submit"]'));
                productForm.insertBefore(statusText, productForm.querySelector('button[type="submit"]'));
            }
            
            progressBar.style.width = percent + '%';
            statusText.textContent = message;
            progressContainer.style.display = 'block';
            statusText.style.display = 'block';
        }

        function hideUploadProgress() {
            const progressContainer = document.getElementById('uploadProgress');
            const statusText = document.getElementById('uploadStatus');
            
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
            if (statusText) {
                statusText.style.display = 'none';
            }
        }

        // ===== REST OF YOUR EXISTING JAVASCRIPT =====
        // [Include all your existing JavaScript functions like:
        // loadProducts(), showToast(), setupEventListeners(), etc.]

        // Initialize the application
        function init() {
            // Your existing initialization code
            setupEventListeners();
            loadProducts();
            checkLoginStatus();
            
            // Add progress bar styles if not in CSS
            addProgressBarStyles();
        }

        // Add dynamic progress bar styles
        function addProgressBarStyles() {
            if (!document.getElementById('progressBarStyles')) {
                const styles = `
                    .upload-progress {
                        width: 100%;
                        height: 6px;
                        background: #f0f0f0;
                        border-radius: 3px;
                        margin: 10px 0;
                        overflow: hidden;
                        display: none;
                    }
                    .upload-progress-bar {
                        height: 100%;
                        background: linear-gradient(90deg, #e67e22, #1a3a8f);
                        border-radius: 3px;
                        transition: width 0.3s ease;
                        width: 0%;
                    }
                    .upload-status {
                        font-size: 0.8rem;
                        color: #666;
                        text-align: center;
                        margin-top: 5px;
                        display: none;
                    }
                `;
                const styleSheet = document.createElement('style');
                styleSheet.id = 'progressBarStyles';
                styleSheet.textContent = styles;
                document.head.appendChild(styleSheet);
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
