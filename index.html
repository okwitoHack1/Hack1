<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Market Onitsha - African Marketplace</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-dark: #1e3d72;
            --primary-light: #4a7bc8;
            --secondary: #f8b500;
            --accent: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
            --white: #ffffff;
            --black: #2c3e50;
            
            --bg-color: #ffffff;
            --text-color: #2c3e50;
            --card-bg: #ffffff;
            --header-bg: #ffffff;
            --footer-bg: #2c3e50;
            --border-color: #ecf0f1;
            
            --border-radius: 12px;
            --border-radius-sm: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --card-bg: #2d2d2d;
            --header-bg: #2d2d2d;
            --footer-bg: #1a1a1a;
            --border-color: #444444;
            --light: #444444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            transition: var(--transition);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .trust-badges {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--white);
            padding: 8px 0;
            font-size: 0.85rem;
        }

        .trust-badges .container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .top-header {
            background: var(--header-bg);
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .top-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contact-info {
            display: flex;
            gap: 25px;
            font-size: 0.9rem;
        }

        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .auth-buttons button {
            padding: 8px 20px;
            border: 1px solid var(--primary);
            background: transparent;
            color: var(--primary);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .auth-buttons button:hover {
            background: var(--primary);
            color: var(--white);
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid var(--gray);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-header {
            background: var(--header-bg);
            padding: 20px 0;
            box-shadow: var(--shadow);
        }

        .logo-section {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 30px;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .logo i {
            font-size: 2.5rem;
            color: var(--primary);
        }

        .search-bar {
            display: flex;
            max-width: 600px;
        }

        .search-bar input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-size: 1rem;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .search-bar button {
            padding: 0 25px;
            background: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            cursor: pointer;
        }

        .user-actions {
            display: flex;
            gap: 25px;
        }

        .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            position: relative;
        }

        .action-item:hover {
            background: var(--light);
        }

        .cart-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--accent);
            color: var(--white);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        nav {
            background: var(--primary-dark);
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 5px;
        }

        .nav-links a {
            color: var(--white);
            text-decoration: none;
            padding: 16px 20px;
            display: block;
            border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
            font-weight: 500;
        }

        .nav-links a:hover, .nav-links a.active {
            background: var(--primary);
        }

        /* Hero Section */
        .hero {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: var(--white);
            padding: 80px 0;
        }

        .hero .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            align-items: center;
        }

        .hero-content h1 {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
        }

        .btn-primary {
            background: var(--secondary);
            color: var(--dark);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--primary);
        }

        /* Video Chat */
        .video-chat-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin: 20px auto;
            max-width: 1000px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            height: 400px;
            padding: 10px;
            background: #1a1a1a;
        }

        .local-video-container, .remote-video-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        .local-video-container video, .remote-video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.7);
            color: white;
            text-align: center;
        }

        .call-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: var(--card-bg);
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--light);
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn.end-call {
            background: var(--danger);
            color: white;
        }

        /* Products */
        .products {
            padding: 80px 0;
            background: var(--bg-color);
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
        }

        .product-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .product-image {
            height: 200px;
            overflow: hidden;
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Seller Dashboard */
        .seller-dashboard {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            margin: 40px 0;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--bg-color);
            color: var(--text-color);
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
        }

        .file-upload input {
            display: none;
        }

        .image-preview {
            margin-top: 15px;
            text-align: center;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: var(--border-radius-sm);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
        }

        /* About Us Page */
        .about-page {
            padding: 80px 0;
            background: var(--bg-color);
        }

        .about-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .about-section {
            margin-bottom: 40px;
        }

        .about-section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
        }

        /* Footer */
        footer {
            background: var(--footer-bg);
            color: var(--white);
            padding: 60px 0 20px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero .container {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .logo-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="trust-badges">
            <div class="container">
                <span><i class="fas fa-shield-alt"></i> 100% Secure</span>
                <span><i class="fas fa-truck"></i> Free Shipping ₦10k+</span>
                <span><i class="fas fa-undo"></i> 7-Day Returns</span>
                <span><i class="fas fa-headset"></i> 24/7 Support</span>
            </div>
        </div>

        <div class="top-header">
            <div class="container">
                <div class="contact-info">
                    <span><i class="fas fa-phone"></i> 0806 456 2826</span>
                    <span><i class="fas fa-envelope"></i> info@mainmarketonitsha.com</span>
                </div>
                <div class="auth-buttons">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="loginBtn">Login</button>
                    <button id="registerBtn">Register</button>
                    <button id="logoutBtn" style="display: none;">Logout</button>
                </div>
            </div>
        </div>
        
        <div class="main-header">
            <div class="container">
                <div class="logo-section">
                    <div class="logo" onclick="showHomePage()">
                        <i class="fas fa-shopping-bag"></i>
                        <div>
                            <span style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">Main Market</span>
                            <span style="font-size: 0.9rem; color: var(--dark);">Onitsha</span>
                        </div>
                    </div>
                    
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search for products...">
                        <button id="searchBtn"><i class="fas fa-search"></i></button>
                    </div>
                    
                    <div class="user-actions">
                        <div class="action-item" id="userAccount">
                            <i class="fas fa-user"></i>
                            <span>Account</span>
                        </div>
                        <div class="action-item" id="sellerDashboardBtn">
                            <i class="fas fa-store"></i>
                            <span>Seller</span>
                        </div>
                        <div class="action-item cart-item" id="viewCart">
                            <i class="fas fa-shopping-cart"></i>
                            <span>Cart</span>
                            <div class="cart-count">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <nav>
            <div class="container">
                <ul class="nav-links">
                    <li><a href="#" class="nav-link active" onclick="showHomePage()">Home</a></li>
                    <li><a href="#" class="nav-link" onclick="showAboutPage()">About Us</a></li>
                    <li><a href="#" class="nav-link" onclick="showVideoChat()">Video Chat</a></li>
                    <li><a href="#" class="nav-link" onclick="showProducts()">Products</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Main Content Area -->
    <main id="mainContent">
        <!-- Home Page (Default) -->
        <section class="hero">
            <div class="container">
                <div class="hero-content">
                    <h1>Discover Authentic African Marketplace</h1>
                    <p>Connect directly with local sellers through live video chat. Support Nigerian businesses.</p>
                    <div class="hero-buttons">
                        <button class="btn btn-primary" onclick="showProducts()">
                            <i class="fas fa-shopping-bag"></i> Start Shopping
                        </button>
                        <button class="btn btn-secondary" onclick="showVideoChat()">
                            <i class="fas fa-video"></i> Try Video Chat
                        </button>
                    </div>
                </div>
                <div class="hero-image">
                    <img src="https://images.unsplash.com/photo-1563013546-7eab76c7af75?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="African Marketplace">
                </div>
            </div>
        </section>

        <!-- Products Section -->
        <section class="products" id="productsSection" style="display: none;">
            <div class="container">
                <h2 style="text-align: center; margin-bottom: 40px; color: var(--primary);">Featured Products</h2>
                <div class="product-grid" id="productGrid">
                    <!-- Products loaded by JavaScript -->
                </div>
            </div>
        </section>

        <!-- Video Chat Section -->
        <section id="videoChatSection" style="display: none;">
            <div class="container">
                <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">Live Video Shopping</h2>
                <div class="video-chat-container">
                    <div class="video-grid">
                        <div class="local-video-container">
                            <video id="localVideo" autoplay muted></video>
                            <div class="video-overlay" id="localOverlay">
                                <i class="fas fa-user video-placeholder"></i>
                                <p>Your camera feed</p>
                            </div>
                        </div>
                        <div class="remote-video-container">
                            <video id="remoteVideo" autoplay></video>
                            <div class="video-overlay" id="remoteOverlay">
                                <i class="fas fa-store video-placeholder"></i>
                                <p>Seller's camera feed</p>
                            </div>
                        </div>
                    </div>
                    <div class="call-controls">
                        <button class="control-btn" id="startCallBtn" onclick="startVideoCall()">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="control-btn" id="muteBtn" onclick="toggleMute()">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="control-btn" id="videoBtn" onclick="toggleVideo()">
                            <i class="fas fa-video"></i>
                        </button>
                        <button class="control-btn end-call" id="endCallBtn" onclick="endVideoCall()">
                            <i class="fas fa-phone"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Seller Dashboard -->
        <section id="sellerDashboard" style="display: none;">
            <div class="container">
                <div class="seller-dashboard">
                    <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary);">Seller Dashboard</h2>
                    <form id="productForm">
                        <div class="form-group">
                            <label for="productName">Product Name</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">Price (₦)</label>
                            <input type="number" id="productPrice" required>
                        </div>
                        <div class="form-group">
                            <label for="productDescription">Description</label>
                            <textarea id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="productCategory">Category</label>
                            <select id="productCategory" required>
                                <option value="">Select Category</option>
                                <option value="fashion">Fashion</option>
                                <option value="electronics">Electronics</option>
                                <option value="home">Home & Living</option>
                                <option value="food">Food</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Product Image</label>
                            <div class="file-upload" onclick="document.getElementById('productImage').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                                <p>Click to upload product image</p>
                                <input type="file" id="productImage" accept="image/*" onchange="previewImage(event)">
                            </div>
                            <div class="image-preview" id="imagePreview"></div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </form>
                </div>
            </div>
        </section>

        <!-- About Us Page -->
        <section id="aboutPage" class="about-page" style="display: none;">
            <div class="container">
                <div class="about-content">
                    <div class="about-section">
                        <h2>About Main Market Onitsha</h2>
                        <p>Main Market Onitsha is Nigeria's premier online marketplace, connecting buyers and sellers across the nation. Founded in 2020, we've grown to become the trusted platform for authentic African products and local businesses.</p>
                    </div>
                    
                    <div class="about-section">
                        <h2>Our Mission</h2>
                        <p>To empower Nigerian entrepreneurs by providing them with cutting-edge digital tools and nationwide reach. We believe every seller deserves access to both local and national markets.</p>
                    </div>
                    
                    <div class="about-section">
                        <h2>Why Choose Us?</h2>
                        <p>• Live Video Chat with sellers before purchasing<br>
                           • 100% Secure Payment System<br>
                           • 5 Physical Branches Nationwide<br>
                           • 7-Day Return Policy<br>
                           • 24/7 Customer Support</p>
                    </div>
                    
                    <div class="about-section">
                        <h2>Our Branches</h2>
                        <p>• Onitsha Main Branch<br>
                           • Lagos Island Branch<br>
                           • Abuja Central Branch<br>
                           • Port Harcourt Branch<br>
                           • Ibadan Branch</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>Main Market Onitsha</h3>
                    <p>Connecting Nigerian buyers and sellers through technology.</p>
                </div>
                <div class="footer-column">
                    <h3>Contact Info</h3>
                    <p><i class="fas fa-phone"></i> 0806 456 2826</p>
                    <p><i class="fas fa-envelope"></i> info@mainmarketonitsha.com</p>
                </div>
            </div>
            <div class="copyright">
                <p>&copy; 2024 Main Market Onitsha. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Login</h2>
                <button class="close-modal" onclick="closeModal('loginModal')">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Register</h2>
                <button class="close-modal" onclick="closeModal('registerModal')">&times;</button>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <div class="form-group">
                    <label>Account Type</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1;">
                            <input type="radio" name="userType" value="buyer" checked> Buyer
                        </label>
                        <label style="flex: 1;">
                            <input type="radio" name="userType" value="seller"> Seller
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Register</button>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCl90i83O7fkn4XolABcQ4bfQeo-OedQt8",
            authDomain: "mainmarketonitsha-a8d07.firebaseapp.com",
            projectId: "mainmarketonitsha-a8d07",
            storageBucket: "mainmarketonitsha-a8d07.firebasestorage.app",
            messagingSenderId: "118338230237",
            appId: "1:118338230237:web:624719a4cc3f91d0d90834"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let products = [];
        let cart = [];

        // Video Chat Variables
        let localStream = null;
        let peerConnection = null;
        let isCallActive = false;
        let isMuted = false;
        let isVideoOff = false;

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            setupEventListeners();
            setupAuthStateListener();
            loadProductsFromFirebase();
            updateCartCount();
        }

        // Firebase Authentication
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName
                    };
                    // Check if user is seller in Firestore
                    checkUserRole(user.uid);
                } else {
                    currentUser = null;
                }
                updateAuthUI();
            });
        }

        async function checkUserRole(uid) {
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    currentUser.role = userDoc.data().role;
                }
            } catch (error) {
                console.error('Error checking user role:', error);
            }
        }

        // Page Navigation
        function showHomePage() {
            hideAllSections();
            document.querySelector('.hero').style.display = 'block';
            updateNavActive('home');
        }

        function showAboutPage() {
            hideAllSections();
            document.getElementById('aboutPage').style.display = 'block';
            updateNavActive('about');
        }

        function showVideoChat() {
            hideAllSections();
            document.getElementById('videoChatSection').style.display = 'block';
            updateNavActive('video');
        }

        function showProducts() {
            hideAllSections();
            document.getElementById('productsSection').style.display = 'block';
            loadProductsFromFirebase();
            updateNavActive('products');
        }

        function showSellerDashboard() {
            if (currentUser && currentUser.role === 'seller') {
                hideAllSections();
                document.getElementById('sellerDashboard').style.display = 'block';
            } else {
                showToast('Please register as a seller first', 'error');
            }
        }

        function hideAllSections() {
            document.querySelector('.hero').style.display = 'none';
            document.getElementById('productsSection').style.display = 'none';
            document.getElementById('videoChatSection').style.display = 'none';
            document.getElementById('sellerDashboard').style.display = 'none';
            document.getElementById('aboutPage').style.display = 'none';
        }

        function updateNavActive(page) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
        }

        // Product Management with Firebase
        async function loadProductsFromFirebase() {
            try {
                const querySnapshot = await db.collection('products').get();
                products = [];
                querySnapshot.forEach((doc) => {
                    products.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderProducts();
            } catch (error) {
                console.error('Error loading products:', error);
                showToast('Error loading products', 'error');
            }
        }

        function renderProducts() {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = products.map(product => `
                <div class="product-card">
                    <div class="product-image">
                        <img src="${product.imageUrl}" alt="${product.name}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    </div>
                    <div class="product-info" style="padding: 20px;">
                        <h3 style="margin-bottom: 10px;">${product.name}</h3>
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 10px;">
                            ₦${product.price.toLocaleString()}
                        </div>
                        <p style="color: var(--gray); margin-bottom: 15px;">${product.description}</p>
                        <div style="font-size: 0.9rem; color: var(--gray); margin-bottom: 10px;">
                            Category: ${product.category}
                        </div>
                        <button class="btn btn-primary" onclick="addToCart('${product.id}')" style="width: 100%;">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Product Form Handler with Firebase Storage
        document.getElementById('productForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser || currentUser.role !== 'seller') {
                showToast('Please register as a seller first', 'error');
                return;
            }

            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productDescription = document.getElementById('productDescription').value;
            const productCategory = document.getElementById('productCategory').value;
            const productImage = document.getElementById('productImage').files[0];

            if (!productImage) {
                showToast('Please select a product image', 'error');
                return;
            }

            try {
                // Upload image to Firebase Storage
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`products/${Date.now()}_${productImage.name}`);
                const snapshot = await imageRef.put(productImage);
                const imageUrl = await snapshot.ref.getDownloadURL();

                // Save product to Firestore
                await db.collection('products').add({
                    name: productName,
                    price: parseInt(productPrice),
                    description: productDescription,
                    category: productCategory,
                    imageUrl: imageUrl,
                    sellerId: currentUser.uid,
                    sellerEmail: currentUser.email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Reset form
                this.reset();
                document.getElementById('imagePreview').innerHTML = '';
                
                showToast('Product added successfully!');
                loadProductsFromFirebase();
                showProducts();
                
            } catch (error) {
                console.error('Error adding product:', error);
                showToast('Error adding product', 'error');
            }
        });

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                    `;
                };
                reader.readAsDataURL(file);
            }
        }

        // Shopping Cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                cart.push(product);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartCount();
                showToast(`${product.name} added to cart!`);
            }
        }

        function updateCartCount() {
            const savedCart = JSON.parse(localStorage.getItem('cart')) || [];
            document.querySelector('.cart-count').textContent = savedCart.length;
        }

        // Video Chat Functions
        async function startVideoCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                document.getElementById('localOverlay').style.display = 'none';
                document.getElementById('startCallBtn').style.display = 'none';
                
                // In a real implementation, you would set up WebRTC peer connection here
                // For demo, we'll simulate a remote connection
                setTimeout(() => {
                    document.getElementById('remoteOverlay').style.display = 'none';
                    showToast('Seller joined the call! You can now discuss the product.');
                }, 2000);
                
                isCallActive = true;
            } catch (error) {
                showToast('Error accessing camera/microphone: ' + error.message, 'error');
            }
        }

        function toggleMute() {
            if (localStream) {
                const audioTracks = localStream.getAudioTracks();
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isMuted = !isMuted;
                document.getElementById('muteBtn').innerHTML = 
                    isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                videoTracks.forEach(track => {
                    track.enabled = !track.enabled;
                });
                isVideoOff = !isVideoOff;
                document.getElementById('videoBtn').innerHTML = 
                    isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
            }
        }

        function endVideoCall() {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('localOverlay').style.display = 'flex';
            document.getElementById('remoteOverlay').style.display = 'flex';
            document.getElementById('startCallBtn').style.display = 'flex';
            
            isCallActive = false;
            showToast('Call ended');
        }

        // Auth Functions with Firebase
        function setupEventListeners() {
            document.getElementById('loginBtn').addEventListener('click', () => {
                document.getElementById('loginModal').style.display = 'flex';
            });

            document.getElementById('registerBtn').addEventListener('click', () => {
                document.getElementById('registerModal').style.display = 'flex';
            });

            document.getElementById('sellerDashboardBtn').addEventListener('click', showSellerDashboard);

            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    closeModal('loginModal');
                    showToast('Login successful!');
                } catch (error) {
                    showToast('Login failed: ' + error.message, 'error');
                }
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const userType = document.querySelector('input[name="userType"]:checked').value;
                
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({
                        displayName: name
                    });

                    // Save user role to Firestore
                    await db.collection('users').doc(userCredential.user.uid).set({
                        name: name,
                        email: email,
                        role: userType,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    closeModal('registerModal');
                    showToast(`Registration successful! Welcome ${name}`);
                } catch (error) {
                    showToast('Registration failed: ' + error.message, 'error');
                }
            });

            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
        }

        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userAccount = document.getElementById('userAccount');

            if (currentUser) {
                loginBtn.style.display = 'none';
                registerBtn.style.display = 'none';
                logoutBtn.style.display = 'block';
                userAccount.querySelector('span').textContent = currentUser.displayName || 'Account';
            } else {
                loginBtn.style.display = 'block';
                registerBtn.style.display = 'block';
                logoutBtn.style.display = 'none';
                userAccount.querySelector('span').textContent = 'Account';
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                showToast('Logged out successfully');
            } catch (error) {
                showToast('Logout failed: ' + error.message, 'error');
            }
        }

        // Dark Mode
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const themeToggle = document.getElementById('themeToggle');
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // Check for saved theme
        function checkSavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        // Utility Functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Initialize theme
        checkSavedTheme();
    </script>
</body>
</html>
